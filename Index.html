<script>
        const year = 2025;
        const plannerTable = document.getElementById('planner-table');
        const notesModal = document.getElementById('notes-modal');
        const modalContent = notesModal.querySelector('.modal-content');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalTitle = document.getElementById('modal-title');
        const modalDateDisplay = document.getElementById('modal-date-display');
        const noteInput = document.getElementById('note-input');
        const saveNoteBtn = document.getElementById('save-note-btn');
        const deleteNoteBtn = document.getElementById('delete-note-btn');
        const colorPicker = document.getElementById('color-picker');
        const colorSwatches = document.getElementById('color-swatches');
        const exportPdfBtn = document.getElementById('export-pdf-btn'); // New PDF export button

        let currentEditingDate = null; // Format: 'YYYY-MM-DD', 'weekly-specific-week-X', or 'phase-note-X'
        let notes = {}; // Stores daily and single-week 'weekly' notes
        // Stores multi-week 'phase' notes
        let multiWeekNotes = [
            { id: 'phase-note-0', text: '', color: 'bg-indigo-500', startWeekIndex: 0, spanWeeks: 26 }
        ];

        const daysOfWeek = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];

        // Define the 26 weeks based on the source Markdown
        const allPlannerWeeks = [
            { weekNum: 1, startDate: '2025-05-05' }, { weekNum: 2, startDate: '2025-05-12' },
            { weekNum: 3, startDate: '2025-05-19' }, { weekNum: 4, startDate: '2025-05-26' },
            { weekNum: 5, startDate: '2025-06-02' }, { weekNum: 6, startDate: '2025-06-09' },
            { weekNum: 7, startDate: '2025-06-16' }, { weekNum: 8, startDate: '2025-06-23' },
            { weekNum: 9, startDate: '2025-06-30' }, { weekNum: 10, startDate: '2025-07-07' },
            { weekNum: 11, startDate: '2025-07-14' }, { weekNum: 12, startDate: '2025-07-21' },
            { weekNum: 13, startDate: '2025-07-28' }, { weekNum: 14, startDate: '2025-08-04' },
            { weekNum: 15, startDate: '2025-08-11' }, { weekNum: 16, startDate: '2025-08-18' },
            { weekNum: 17, startDate: '2025-08-25' }, { weekNum: 18, startDate: '2025-09-01' },
            { weekNum: 19, startDate: '2025-09-08' }, { weekNum: 20, startDate: '2025-09-15' },
            { weekNum: 21, startDate: '2025-09-22' }, { weekNum: 22, startDate: '2025-09-29' },
            { weekNum: 23, startDate: '2025-10-06' }, { weekNum: 24, startDate: '2025-10-13' },
            { weekNum: 25, startDate: '2025-10-20' }, { weekNum: 26, startDate: '2025-10-27' },
        ];

        const defaultPillColor = 'bg-indigo-500';
        const colorClassMap = {
            '#6366f1': 'bg-indigo-500', // Indigo
            '#a855f7': 'bg-purple-500', // Purple
            '#0ea5e9': 'bg-sky-500',    // Sky Blue
            '#f43f5e': 'bg-rose-500'    // Rose
        };
        const reverseColorClassMap = {
            'bg-indigo-500': '#6366f1',
            'bg-purple-500': '#a855f7',
            'bg-sky-500': '#0ea5e9',
            'bg-rose-500': '#f43f5e'
        };

        function formatDate(date) { // date is a Date object
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `<span class="math-inline">\{date\.getFullYear\(\)\}\-</span>{month}-${day}`;
        }

        // Load data from Local Storage on page load
        function loadPlannerData() {
            const storedNotes = localStorage.getItem('plannerNotes');
            if (storedNotes) {
                notes = JSON.parse(storedNotes);
            }
            const storedMultiWeekNotes = localStorage.getItem('multiWeekNotes');
            if (storedMultiWeekNotes) {
                multiWeekNotes = JSON.parse(storedMultiWeekNotes);
            }
        }

        // Save data to Local Storage
        function savePlannerData() {
            localStorage.setItem('plannerNotes', JSON.stringify(notes));
            localStorage.setItem('multiWeekNotes', JSON.stringify(multiWeekNotes));
        }

        // Global variable to store the calculated width of a single week column
        let singleColumnPixelWidth = 0;

        function renderPlanner() {
            const weeksToDisplay = allPlannerWeeks;

            const tableHead = plannerTable.querySelector('thead tr');
            const tableBody = plannerTable.querySelector('tbody');

            // Clear previous content
            tableHead.innerHTML = '<th class="p-3 text-left text-sm font-semibold tracking-wider border border-indigo-700 table-fixed-col bg-indigo-800 day-column-width">Day</th>';
            tableBody.innerHTML = '';

            // Populate headers
            weeksToDisplay.forEach(weekData => {
                const th = document.createElement('th');
                // Removed min-w for auto-adjusting width based on content.
                // The actual width will be determined by content and browser's table layout algorithm.
                th.className = "p-3 text-center text-sm font-semibold tracking-wider border border-indigo-700";
                const monDate = new Date(weekData.startDate + 'T00:00:00');
                const friDate = new Date(monDate);
                friDate.setDate(monDate.getDate() + 4);
                th.innerHTML = `Week <span class="math-inline">\{weekData\.weekNum\}<br\><span class\="font\-normal text\-xs"\>\(</span>{monDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${friDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })})</span>`;
                tableHead.appendChild(th);
            });

            // After rendering headers, measure a typical column width
            // This is crucial for drag-and-drop snapping
            requestAnimationFrame(() => { // Use rAF to ensure layout is stable
                const firstDataColumnHeader = tableHead.querySelector('th:not(.day-column-width)');
                if (firstDataColumnHeader) {
                    singleColumnPixelWidth = firstDataColumnHeader.offsetWidth;
                }
            });


            // Add the 'Phase' row for multi-week notes
            const phaseTr = document.createElement('tr');
            phaseTr.className = 'bg-white';
            const phaseTh = document.createElement('th');
            phaseTh.className = "p-3 text-left text-sm font-medium border border-stone-300 table-fixed-col bg-blue-1